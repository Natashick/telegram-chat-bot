# Update ‚Äî 2025‚Äë11‚Äë19

## –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

- –ü–µ—Ä–µ–≤–æ–¥ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –Ω–∞ CPU‚Äë–º–æ–¥–µ–ª—å `sentence-transformers` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `sentence-transformers/all-MiniLM-L6-v2`).
  - –ë–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º `OLLAMA_EMBED_MODEL` –∏ `/api/embeddings`; —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ Chroma —á–µ—Ä–µ–∑ `embeddings=`.
  - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `EMBED_BATCH_SIZE` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `16`).

- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `vector_store.py`:
  - –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏; Chroma —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å `embedding_function=None`.
  - –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `add_chunks(doc_id, chunks, metadata)` ‚Äî –±–∞—Ç—á–µ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤.
  - `add_document(...)` —Ç–µ–ø–µ—Ä—å –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ `add_chunks(...)` —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —á–∞–Ω–∫–∏–Ω–≥ (`CHUNK_SIZE`, `CHUNK_OVERLAP`).
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `has_document` (—É–±—Ä–∞–Ω –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π `include=['ids']`, –∏–∑‚Äë–∑–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ —à–ª–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è).
  - `search_in_document` —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ `similarity_score` (—Ä–∞–Ω—å—à–µ –±—ã–ª –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á).
  - –°—Ç–∞–±–∏–ª—å–Ω—ã–µ ID —á–∞–Ω–∫–æ–≤: `sha1(abs_path)[:8]_chunk_{i}`; –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–∏—à–µ–º `source`, `doc_id`, `chunk_index`, `chunk_id`, `total_chunks`, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `doc_version`.
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã: `search_in_document`, `get_combined_context_for_document`, `has/delete/get_document_info`. –û—Å—Ç–∞–≤–ª–µ–Ω—ã `index/search/delete_titles` (–≤–∫–ª—é—á–∞—é—Ç—Å—è `ENABLE_TITLE_INDEX=1`).

- `handlers.py`:
  - –í `_ensure_document_indexed` –∑–∞–º–µ–Ω—ë–Ω –≤—ã–∑–æ–≤ `add_document(...)` –Ω–∞ **–ø—Ä—è–º–æ–π** `add_chunks(...)` (–±–µ–∑ —Å–∫–ª–µ–π–∫–∏ –æ–≥—Ä–æ–º–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Üí –º–µ–Ω—å—à–µ –ø–∏–∫–æ–≤ –ø–∞–º—è—Ç–∏).
  - –°–æ–æ–±—â–µ–Ω–∏—è ¬´–ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶¬ª –∏ ¬´–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ¬ª —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ (`context.user_data['lang']`, –∫–Ω–æ–ø–∫–∞ ¬´üåê Language: EN/DE¬ª).
  - –î–æ–±–∞–≤–ª–µ–Ω **fallback**: –µ—Å–ª–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö PDF –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ `vector_store.query()` –ø–æ –≤—Å–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è.

- `bot.py`:
  - `set_webhook(..., drop_pending_updates=True, allowed_updates=[\"message\",\"callback_query\"])` ‚Äî –Ω–µ —Ç—è–Ω–µ–º —Å—Ç–∞—Ä—ã–µ –∞–ø–¥–µ–π—Ç—ã –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤.
  - –í `lifespan`: –µ—Å–ª–∏ `PREINDEX_ENABLED=1` ‚Üí —Å—Ç–∞—Ä—Ç—É–µ–º –ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é; –µ—Å–ª–∏ —Ñ–ª–∞–≥ 0, –Ω–æ –∏–Ω–¥–µ–∫—Å –ø—É—Å—Ç–æ–π ‚Üí –ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (–ª–æ–≥: `Preindex task started ‚Ä¶ (auto=‚Ä¶)`).

- Docker/–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
  - `Dockerfile`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ CPU‚Äë–≤–µ—Ä—Å–∏–∏ PyTorch (`torch/torchvision/torchaudio` —á–µ—Ä–µ–∑ `https://download.pytorch.org/whl/cpu`), —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤ BLAS (OMP/OPENBLAS/MKL/NUMEXPR=1).
  - `requirements.txt`: –¥–æ–±–∞–≤–ª–µ–Ω—ã `sentence-transformers==2.7.0`, `httpx==0.25.2` (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å `python-telegram-bot==20.7`), `python‚Äëdotenv==1.0.1`.
  - `docker-compose.yml`: –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω `OLLAMA_EMBED_MODEL`, —É–±—Ä–∞–Ω `EMBED_CONCURRENCY`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `CHUNK_SIZE=800`, `CHUNK_OVERLAP=200`, `EMBED_BATCH_SIZE=16`, `PREINDEX_ENABLED=1`, `MAX_INDEX_CHUNKS=0`, –¥–æ–±–∞–≤–ª–µ–Ω `EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2`. –£–¥–∞–ª—ë–Ω —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á `CHROMA_DISABLE_TECHNOLOGY`.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- ¬´Expected include item ‚Ä¶ got `ids`¬ª –≤ Chroma –∏–∑‚Äë–∑–∞ `has_document(..., include=['ids'])` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ.
- –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ PDF –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–æ–ø—Ä–æ—Å–µ ‚Äî —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `has_document`, –ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è, –ø—Ä—è–º–æ–µ `add_chunks`, –∞–≤—Ç–æ‚Äë–ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–∏ –ø—É—Å—Ç–æ–π –±–∞–∑–µ).
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π `httpx` —Å `python-telegram-bot` ‚Äî –∑–∞–∫—Ä–µ–ø–ª—ë–Ω `httpx==0.25.2`.
- –°–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ —Ç–µ–ø–µ—Ä—å –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —è–∑—ã–∫—É (DE/EN) –∏ –¥–ª—è ¬´–ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶¬ª/¬´–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ¬ª.

## –í–∞–∂–Ω–æ –ø—Ä–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (.env / compose)

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã:

```
EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
CHUNK_SIZE=800
CHUNK_OVERLAP=200
BATCH_SIZE=1
EMBED_BATCH_SIZE=16
MAX_INDEX_CHUNKS=0         # 0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞ (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ 50‚Äì100)
INDEX_CONCURRENCY=1
PREINDEX_ENABLED=1
OCR_ENABLED=0
CHROMA_DB_DIR=/app/chroma_db
PDF_DIR=/app/pdfs
OLLAMA_URL=http://host.docker.internal:11434
OLLAMA_MODEL=llama3.2:1b
MAX_UPDATE_CONCURRENCY=2
CHROMA_DISABLE_TELEMETRY=1
ANONYMIZED_TELEMETRY=False
```

–£–¥–∞–ª–∏—Ç—å/–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: `OLLAMA_EMBED_MODEL`, `EMBED_CONCURRENCY`, —Å—Ç–∞—Ä—ã–µ `CHUNK_SIZE=2000`, `CHUNK_OVERLAP=120`, `PREINDEX_ENABLED=0`.

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

1. –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è:  
   ```powershell
   Remove-Item -Recurse -Force .\\chroma_db\\*
   docker compose build --no-cache
   docker compose up -d
   docker compose logs -f bot
   ```
   –û–∂–∏–¥–∞–µ–º–æ: `Vector Store ‚Ä¶ chunk=800 overlap=200 ‚Ä¶` –∏ —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ `Added N chunks for /app/pdfs/...` –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å.

2. –¢–µ—Å—Ç –≤ Telegram:  
   `/start` ‚Üí –≤—ã–±—Ä–∞—Ç—å —è–∑—ã–∫ (EN/DE) ‚Üí ¬´what is ISO/SAE 21434?¬ª –∏–ª–∏ ¬´was ist ISO SAE 21434?¬ª  
   –û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ, —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π. –ü—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É PDF —Å—Ä–∞–±–æ—Ç–∞–µ—Ç fallback‚Äë–ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏.

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- –í–∫–ª—é—á–∏—Ç—å `ENABLE_TITLE_INDEX=1` –∏ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–∏—Å–∫/¬´üñº Page screenshot¬ª –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º —Ä–∏—Å—É–Ω–∫–æ–≤/—Ç–∞–±–ª–∏—Ü/—Ä–∞–∑–¥–µ–ª–æ–≤ (–≤–∫–ª—é—á–∞–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é `page_titles`, —Ç–∞–∫–∂–µ –Ω–∞ sentence‚Äëtransformers).
- –ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ RAM –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å `MAX_INDEX_CHUNKS` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50‚Äì100), –∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∏–ª–∏ —Å—Ç–∞–≤–∏—Ç—å 0, –∫–æ–≥–¥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
- –ü–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ ‚Äî —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏–≤ `handlers` —Ü–µ–ª–∏–∫–æ–º –Ω–∞ `vector_store.query()` –±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞ PDF (–ø–æ –∂–µ–ª–∞–Ω–∏—é).


