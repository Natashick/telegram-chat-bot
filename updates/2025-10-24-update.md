## Update — 2025-10-24 — Telegram RAG Bot (ChromaDB + Ollama)

### Ziele heute
- Stabiler Betrieb (geringe Last), korrekte Indexierung/Embeddings, funktionierender Telegram‑Webhook über ngrok.

### Probleme & Ursachen
- Hohe CPU‑Last: gleichzeitige OCR + Embeddings + LLM.
- Webhook 404/502: veraltete/zeitkritische ngrok‑URL; Webhook blockierte die Verarbeitung.
- „Dokumente nicht gefunden“: falsches `PDF_DIR`/Mount; PDFs lagen nicht in `/app/pdfs`.
- Keine Suchtreffer: Ollama Embeddings gaben bei `input` leere Vektoren; benötigt `prompt`.
- InvalidToken beim Start: abgeschnittener Telegram‑Token.

### Umgesetzte Änderungen
- Docker‑Start mit Limits (`--cpus=1.0`, `--memory=2g`) und kleinerem LLM `OLLAMA_MODEL=llama3.2:1b`.
- Persistenter Mount der PDFs: `-v ./pdfs:/app/pdfs:ro`, `PDF_DIR=/app/pdfs`.
- Embeddings‑Fix in `vector_store.py`:
  - Fallback: wenn Batch/Item mit `input` leer → per‑Item mit `prompt`.
  - Validierung der Embedding‑Antworten; `batch_size` von 16 → 4.
- Webhook entblockt in `bot.py`:
  - `asyncio.create_task(application.process_update(update))` → sofortiges 200, kein 502 mehr.
- Ngrok/Webhook neu gesetzt: `https://<id>.ngrok-free.app/webhook/secret123`.

### Verifizierungen
- `/health` = healthy, Webhook korrekt gesetzt (getWebhookInfo ohne Fehler).
- Container sieht PDFs in `/app/pdfs`.
- Embeddings aus Container: `prompt` → Vektor (≈768 Dim), Indexierung läuft.

### Befehle (Kurzreferenz)
```powershell
# Build & Run (Webhook)
docker build -t mein-bot .
docker rm -f mein-bot 2>$null
$token="<TELEGRAM_TOKEN>"; $ng="https://<id>.ngrok-free.app"
docker run -d --name mein-bot `
  --cpus=1.0 --memory=2g `
  -e TELEGRAM_TOKEN="$token" `
  -e WEBHOOK_URL="$ng" -e WEBHOOK_SECRET="secret123" `
  -e OLLAMA_URL="http://host.docker.internal:11434" `
  -e OLLAMA_MODEL="llama3.2:1b" -e OLLAMA_EMBED_MODEL="nomic-embed-text" `
  -e OCR_CONCURRENCY=1 -e PDF_DIR="/app/pdfs" `
  -v "${PWD}\pdfs:/app/pdfs:ro" -v "${PWD}\chroma_db:/app/chroma_db" `
  -p 8000:8000 mein-bot

# Webhook reset
(Invoke-WebRequest -UseBasicParsing "https://api.telegram.org/bot$token/deleteWebhook?drop_pending_updates=true").Content
(Invoke-WebRequest -UseBasicParsing "https://api.telegram.org/bot$token/setWebhook?url=$ng/webhook/secret123").Content
(Invoke-WebRequest -UseBasicParsing "https://api.telegram.org/bot$token/getWebhookInfo").Content
```

### Nächste Schritte
- Optional: OCR‑DPI reduzieren; ggf. `chunk_size/overlap` feinjustieren.
- Falls weiter 502 auftreten: ngrok‑URL aktualisieren oder temporär auf Polling schalten (ohne `WEBHOOK_URL`).

—
Erstellt am 2025‑10‑24. Zusammenfassung der heutigen Arbeiten und Fixes.

