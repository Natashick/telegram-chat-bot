## Update – 2025-11-23

### Изменения по коду
- handlers1.py
  - Убран вывод сырых цитат (EXACT_QUOTE); найденные определения/точные фрагменты проходят через LLM и отправляются как связный ответ.
  - Гейт “термин должен быть в контексте” применяется только к коротким UPPERCASE‑акронимам (2–5 букв); ISO/SAE 21434 и похожие термины не блокируются.
  - В пагинации отключён parse_mode=MARKDOWN, чтобы не ломались сообщения с PDF‑символами.
- retrieval.py
  - Единая детекция акронимов: импорт из `acronym_utils.detect_acronym`.
  - Совпадение: для коротких UPPERCASE — строго по границам слова; для составных/цифровых — нормализованный contains.
  - Progressive widening по всему документу (×10 → ×30), дедупликация и сортировка по similarity сохранены.
  - Восстановлена `find_chunk_with_term` на базе `_matches_term`.
- vector_store.py
  - Проверены `_embed` и `_hash_path`; удалены возможные “висячие” строки/дубли. Логирование телеметрии Chroma подавлено как косметическое.

### Тесты
- Smoke‑тесты (в контейнере, без LLM): ISO/SAE 21434, RASIC, CAN/CAN‑FD, G20, ISO 9001.
  - ISO/SAE 21434 — релевантные выдержки (6 чанков), ответы ожидаемо есть.
  - RASIC/CAN — при отсутствии точного вхождения гейт для коротких UPPERCASE выдаёт “Keine relevanten Informationen im Kontext.” (ожидаемо, без галлюцинаций).
  - G20 — нейтрально (термина в документах нет).
  - ISO 9001 — встречается в библиографии; без галлюцинаций.
- White‑box (tests/test_whitebox.py) — WHITEBOX OK:
  - `detect_acronym`, `_matches_term`, `find_definition_in_chunks`, `build_combined_excerpts`.
  - Проверены дедупликация и сортировка чанков.

### Рекомендации по окружению (на время отладки)
- `.env`: `MAX_INDEX_CHUNKS=0`, `EMBED_BATCH_SIZE=16`, `INDEX_CONCURRENCY=1`, `MIN_CHUNK_WORDS=1`, `MIN_CHUNK_CHARS=10`, `MIN_SIM_THRESHOLD=0.0–0.05`, `CHROMA_DISABLE_TELEMETRY=1`, `DEBUG_PROMPTS=1` (временно).

### Что проверить руками в Telegram
- Вопросы: “was ist das ISO/SAE 21434?”, “RASIC”, “CAN/CAN‑FD”, “G20”, “ISO 9001”.
- Ожидания: короткие UPPERCASE (CAN/RASIC) отвечают только при присутствии термина; ISO/SAE 21434 — краткий ответ 2–5 предложений; без Markdown‑ломок.

### Открытые пункты
- Динамика длины ответа — уже включена в `llm_client` (можно расширить ключевые слова RU/DE/EN при необходимости).

### Быстрый деплой/перезапуск
```
docker compose build --no-cache && docker compose up -d
```


