## Update ‚Äî 2025‚Äë11‚Äë17 ‚Äî Stabilit√§t, Webhook, Vor‚ÄëIndex & UI‚ÄëBausteine

### Ziel
- Stabiler Telegram‚ÄëBot (Webhook via ngrok) mit schneller RAG‚ÄëSuche √ºber PDF‚ÄëKorpus, Vor‚ÄëIndex optional, UI‚ÄëGrundfunktionen (Start/Language, Pagination, Screenshot nach Titel).

### Gemachte √Ñnderungen
1) Webhook/Lebenszyklus
   - `bot.py`: Wechsel auf FastAPI‚ÄëLifespan (statt `on_event`) ‚Üí Entfernt Deprecation‚ÄëWarnung.
   - Webhook‚ÄëHandler **nicht blockierend**: `asyncio.create_task(...)`, jetzt mit **Update‚ÄëSema** `_UPDATE_SEMA` und `MAX_UPDATE_CONCURRENCY` (default 10) ‚Üí keine Task‚ÄëFlut bei vielen Updates.
   - Optionaler **Vor‚ÄëIndex im Hintergrund** nur, wenn `PREINDEX_ENABLED=1`. Standard: aus, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å OOM beim Start.

2) RAG / VectorStore & Embeddings
   - `vector_store.py`:
     - Embedding‚ÄëLimiter: `EMBED_CONCURRENCY` (default 1) begrenzt gleichzeitige `/api/embeddings`‚ÄëAufrufe (weniger Peaks/OOM).
     - Zusatz‚ÄëSammlung `page_titles` + Methoden `index_page_titles`, `search_titles` (leichter Titel/Caption‚ÄëIndex mit `doc_id/page/type/title`). 
     - `delete_document` + `delete_titles_for_doc` + `get_document_version` ‚Üí **idempotente Re‚ÄëIndexierung** (nur bei ge√§nderter Datei; vor Neuindex werden alte Titel entfernt).
   - `handlers.py`:
     - **Vor‚ÄëIndex**: `preindex_all_pdfs()` sequentiell, mit Fortschritt in `/status` (`Preindex: X/Y`), keine Quellen in Antworten.
     - Spezifische/Globale Suche nutzen `ask_ollama(..., target_language)`; lange Antworten werden **automatisch paginiert** (‚âà3.6k Zeichen/Seite) mit ‚Äû‚óÄÔ∏è/‚ñ∂Ô∏è‚Äú und ‚ÄûüìÑ X/Y‚Äú.
     - ‚ÄûScreenshot nach Titel‚Äú: —Ä–µ–∂–∏–º `awaiting_title` ‚Üí Suche –ø–æ `page_titles` ‚Üí –≤—ã–±–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ‚Üí —Ä–µ–Ω–¥–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ PNG.
   - `llm_client.py`:
     - System‚ÄëPrompt —Å –∂—ë—Å—Ç–∫–æ–π —è–∑—ã–∫–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π (EN/DE), –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤/—Å—Ç—Ä–∞–Ω–∏—Ü.
     - `MAX_TOKENS=1024`, `options.num_thread=2`.
     - **Fallback** –Ω–∞ `generate` –±–µ–∑ `num_predict` –ø—Ä–∏ 400/422 (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ Ollama).

3) Parser / OCR
   - `pdf_parser.py`:
     - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω **regex** –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤/–ø–æ–¥–ø–∏—Å–µ–π (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è).
     - `extract_titles_from_pdf` —Ç–µ–ø–µ—Ä—å **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è** (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `to_thread`), –±–µ–∑ `asyncio.run` –≤–Ω—É—Ç—Ä–∏.
     - –£—Ç–∏–ª–∏—Ç–∞ `get_page image bytes` –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

4) Telemetrie/Build/Compose
   - `Dockerfile`: `CHROMA_DISABLE_TELEMETRY=1` ‚Üí —É–±—Ä–∞–Ω—ã –æ—à–∏–±–∫–∏ posthog.
   - `docker-compose.yml`: –æ–±—Ä–∞–∑ `mein-bot`, —Ç–æ–º–∞ `./pdfs:/app/pdfs:ro`, `./chroma_db:/app/chroma_db`; ENV‚Äë–¥–µ—Ñ–æ–ª—Ç—ã (`PDF_DIR=/app/pdfs`, `OLLAMA_URL=http://*host.docker.internal*:11434`, `OLLAMA_MODEL=llama3.2:3b`), —Ä–µ—Å—Ç–∞—Ä—Ç `unless-stopped`, –ª–∏–º–∏—Ç—ã CPU/Mem.
   - `README.md`: –¥–æ–±–∞–≤–ª–µ–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ compose –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ `.env`, –æ–ø–∏—Å–∞–Ω–∏–µ UI –∏ –ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

### Bekannte Punkte / Ma√ünahmen
- OOM (Exit 137) –ø—Ä–∏ –±–æ–ª—å—à–æ–º –ø—Ä–µ–¥–∏–Ω–¥–µ–∫—Å–µ: –≤–∫–ª—é—á—ë–Ω —Ñ–ª–∞–≥ `PREINDEX_ENABLED` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–≤—ã–∫–ª.**), –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏–º–∏—Ç–µ—Ä `EMBED_CONCURRENCY`. –î–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ—Ä–ø—É—Å–æ–≤ —É–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å WSL2/Docker (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é) –∏–ª–∏ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É.
- –°–æ–æ–±—â–µ–Ω–∏–µ ‚Äúversion is obsolete‚Äù –≤ `docker-compose.yml` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ Docker Compose v2, –Ω–µ –≤–ª–∏—è–µ—Ç; –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫—É `version:`.

### Was jetzt zu tun ist
1) –ü—Ä–æ–≤–µ—Ä—å `.env` (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫):
   ```env
   TELEGRAM_TOKEN=...
   WEBHOOK_URL=https://<dein>.ngrok-free.app
   OLLAMA_URL=http://host.docker.internal:11434
   OLLAMA_MODEL=llama3.2:3b
   OLLAMA_EMBED_MODEL=nomic-embed-text
   OCR_CONCURRENCY=1
   PDF_DIR=/app/pdfs
   # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:
   # PREINDEX_ENABLED=1
   # MAX_UPDATE_CONCURRENCY=10
   # EMBED_CONCURRENCY=1
   ```
2) –ü–æ–ª–æ–∂–∏ PDF –≤ `./pdfs`.  
3) –ó–∞–ø—É—Å–∫:
   ```powershell
   docker compose build --no-cache
   docker compose up -d
   curl http://localhost:8000/health
   ```
4) –í Telegram:
   - `/start` ‚Üí ¬´üü¢ Start¬ª, ¬´üåê Language: EN/DE¬ª
   - `/status` ‚Üí —Å–ª–µ–¥–∏ –∑–∞ `Preindex` –∏ `Indexierte Chunks`
   - –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å; –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî ¬´‚óÄÔ∏è/‚ñ∂Ô∏è¬ª, –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî ¬´Screenshot nach Titel¬ª

### Ergebnis
- –°—Ç–∞–±–∏–ª—å–Ω—ã–π webhook (–±–µ–∑ 502), —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –ø–∞–º—è—Ç—å, —É–ª—É—á—à–µ–Ω–Ω—ã–π UI (—è–∑—ã–∫, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã), –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π RAG —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.


